---
title: "Building Patient-Level Predictive Model with MIMIC-III"
author: "Eduardo Angulo"
date: '`r Sys.Date()`' #"26/5/2022"
output: html_document
---

# Introduction
Loren ipsum

# System specification
Loren ipsum

# Study specification
Loren ipsum

## Study population definition
Loren ipsum

## Model development settings
Loren ipsum

## Study implementation
Loren ipsum

### Cohort instantiation
Loren ipsum

### ATLAS cohort builder
Loren ipsum

### Study script creation
Loren ipsum

### Data extraction
Loren ipsum

### Additional inclusion criteria
Loren ipsum

### Spliting the data into training/validation/testing datasets
Loren ipsum

### Preprocessing the training data
 
It was used the default sample settings. it simply returns the trainData as input, see below: 

```{r tidy=FALSE,eval=FALSE}
  sampleSettings <- PatientLevelPrediction::createSampleSettings()
```

However, the current package contains methods of under-sampling the non-outcome patients.  To perform undersampling, the `type` input should be 'underSample' and `numberOutcomestoNonOutcomes` must be specified (an integer specifying the number of non-outcomes per outcome).  It is possible to add any custom function for over/under sampling, see [vignette for custom sampling](https://github.com/OHDSI/PatientLevelPrediction/blob/master/inst/doc/AddingCustomSamples.pdf).

It is possible to specify a combination of feature engineering functions that take as input the trainData and output a new trainData with different features.  The default feature engineering setting does nothing:

```{r tidy=FALSE,eval=FALSE}
  featureEngineeringSettings <- PatientLevelPrediction::createFeatureEngineeringSettings()
```


Finally, the preprocessing settings.  For this setting it was defined `minFraction = 0.01`, this removes any features that is observed in the training data for less than 0.01 fraction of the patients. The input `normalize = T` specifies whether the features are scaled between 0 and 1.  The input `removeRedundancy = T` specifies whether features that are observed in all of the target population are removed.

```{r tidy=FALSE,eval=FALSE}
  preprocessSettings <- PatientLevelPrediction::createPreprocessSettings(
	minFraction = 0.01, 
	normalize = T, 
	removeRedundancy = T
	)
```


### Model development

For the algorithm selection with considered two options:

- [setLassoLogisticRegression](https://ohdsi.github.io/PatientLevelPrediction/reference/setLassoLogisticRegression.html) : [LASSO regression](https://en.wikipedia.org/wiki/Lasso_(statistics)) is a regression analysis method that performs both variable selection and regularization in order to enhance the prediction accuracy and interpretability of the resulting statistical model.

- [setGradientBoostingMachine](https://ohdsi.github.io/PatientLevelPrediction/reference/setGradientBoostingMachine.html) : [Gradient boosting](https://en.wikipedia.org/wiki/Gradient_boosting) is a machine learning technique used in regression and classification tasks, among others. It gives a prediction model in the form of an ensemble of weak prediction models, which are typically decision trees.

For our problem we choose to build a logistic regression model with the default hyper-parameters
```{r tidy=TRUE,eval=FALSE}
lrModel <- setLassoLogisticRegression()
```
For the gradient boosting machines model it was used the hyper-parameters explained in [vignette for building patient-level predictive models](https://github.com/OHDSI/PatientLevelPrediction/blob/main/inst/doc/BuildingPredictiveModels.pdf).

```{r tidy=TRUE,eval=FALSE}
lrModel <- setGradientBoostingMachine(ntrees = 5000, maxDepth = c(4, 7, 10), learnRate = c(0.001, 
    0.01, 0.1, 0.9))
```

The `runPlP` function requires the `plpData`, the `outcomeId` specifying the outcome being predicted and the settings: `populationSettings`, `splitSettings`, `sampleSettings`, `featureEngineeringSettings`, `preprocessSettings` and `modelSettings` to train and evaluate the model. 

```{r tidy=FALSE,eval=FALSE}
lrResults <- PatientLevelPrediction::runPlp(
	plpData = plpData,
	outcomeId = 3, 
	analysisId = 'Test',
	analysisName = 'Demonstration of runPlp for training single PLP models',
	populationSettings = populationSettings, 
	splitSettings = splitSettings,
	sampleSettings = sampleSettings, 
	featureEngineeringSettings = featureEngineeringSettings, 
	preprocessSettings = preprocessSettings,
	modelSettings = lrModel,
	logSettings = PatientLevelPrediction::createLogSettings(), 
	executeSettings = PatientLevelPrediction::createExecuteSettings(
		runSplitData = T, 
		runSampleData = T, 
		runfeatureEngineering = T, 
		runPreprocessData = T, 
		runModelDevelopment = T, 
		runCovariateSummary = T
	), 
	saveDirectory = file.path(getwd(), '/Home/cohort_test_model_Gio/model_test')
	)
```


### Result analysis
Loren ipsum